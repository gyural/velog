<h1 id="ì„¤ê³„ëŠ”-ì™„ë£Œ">ì„¤ê³„ëŠ” ì™„ë£Œ</h1>
<p>_&quot;<a href="https://velog.io/@gyural/%ED%86%B5%ED%95%A9-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%9D%B4%EB%A0%87%EA%B2%8C%EB%A7%8C-%ED%95%98%EC%9E%90">ì´ì „ ê¸€</a>ì—ì„œ í†µí•© í…ŒìŠ¤íŠ¸ ê´€ë ¨ ìŠ¤í„°ë””ë¥¼ ì™„ë£Œí•˜ê³ , ì„¤ê³„ê¹Œì§€ ì™„ë£Œí•¨&quot;
_</p>
<p>_&quot;ë”°ë¼ì„œ ì´ì œëŠ” ì‹¤ì œ êµ¬í˜„ì„ í•´ë´ì•¼í•œë‹¤&quot;
_</p>
<h1 id="í…ŒìŠ¤íŠ¸-í™˜ê²½">í…ŒìŠ¤íŠ¸ í™˜ê²½</h1>
<div style="display: flex;">
  <img src="https://velog.velcdn.com/images/gyural/post/ba89fa59-f4f9-41d7-bf91-b916d17de478/image.png" width="40%" />
  <img src="https://velog.velcdn.com/images/gyural/post/cc6f798d-82c3-40aa-8083-397c0d747146/image.png" width="40%" />
</div>



<p><code>spring-boot 3.4.x</code> : ë©”ì¸ í”„ë ˆì„ ì›Œí¬
<code>Junit 5</code> : testing ë©”ì„œë“œë¥¼ ìœ„í•´ì„œ í™œìš©
<code>webtestclient</code> :servletìœ„ì—ì„œ ì‹¤ì œ ìš”ì²­ì„ í•˜ê¸°ìœ„í•œ í´ë¼ì´ì–¸íŠ¸
<code>Test-container</code> : ì‹¤ì œ ì¸í”„ë¼ë¥¼ ë„ì»¤ìœ„ì—ì˜¬ë¦¬ê¸° ìœ„í•´ì„œ ì‚¬ìš©í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬</p>
<hr />
<h1 id="êµ¬í˜„í•˜ë©´ì„œ-ê¶ê¸ˆí–ˆë˜-ì ">êµ¬í˜„í•˜ë©´ì„œ ê¶ê¸ˆí–ˆë˜ ì </h1>
<h3 id="q1-mvcë¡œ-http-í´ë¼ì´ì–¸íŠ¸ë¡œ-ì„¤ì •í•˜ë©´-ì™œ-securityë¥¼-ê±´ë„ˆ-ë›°ëŠ”ê±´ì§€">Q1) MVCë¡œ http í´ë¼ì´ì–¸íŠ¸ë¡œ ì„¤ì •í•˜ë©´ ì™œ Securityë¥¼ ê±´ë„ˆ ë›°ëŠ”ê±´ì§€??</h3>
<p>ì•„ë˜ëŠ” ê³µì‹ë¬¸ì„œì—ì„œ ë‚˜íƒ€ë‚´ëŠ” <code>MockMvcWebTestClient</code> ì„¤ëª…ì™€ ì˜ˆì‹œì½”ë“œ ì…ë‹ˆë‹¤.</p>
<p><em>&quot;For Spring MVC, use the following .......(ìƒëµ )&quot;</em></p>
<p>*<em>--&gt; ì¦‰ spring MVCí…ŒìŠ¤íŠ¸ì— ì í•©í•œ í´ë¼ì´ì–¸íŠ¸ì„
*</em></p>
<p><code>ì½”ë“œ</code></p>
<pre><code class="language-java">@ExtendWith(SpringExtension.class)
@WebAppConfiguration(&quot;classpath:META-INF/web-resources&quot;) 
@ContextHierarchy({
    @ContextConfiguration(classes = RootConfig.class),
    @ContextConfiguration(classes = WebConfig.class)
})
class MyTests {

    @Autowired
    WebApplicationContext wac; 

    WebTestClient client;

    @BeforeEach
    void setUp() {
        client = MockMvcWebTestClient.bindToApplicationContext(this.wac).build(); 
    }
}</code></pre>
<p>í˜„ì¬ í”„ë¡œì íŠ¸ëŠ” <code>WebFlux</code>ì•„í‚¤í…ì²˜ê°€ ì•„ë‹Œ <code>MVC</code>ì•„í‚¤í…ì²˜ ì˜€ê¸° ë•Œë¬¸ì— ì´ˆê¸° êµ¬í˜„ì€ í•´ë‹¹ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‚¬ìš©í•´ì¤¬ìŒ</p>
<p><strong>í•˜ì§€ë§Œ...!!!</strong></p>
<blockquote>
<p>ì´ë ‡ê²Œ í•˜ê²Œë˜ë©´ Spring-Securityì¸ê°€ í•„í„°ë¥¼ ê±°ì¹˜ì§€ ì•Šê²Œ ë˜ì—ˆìŒ...!!
ì™œëƒí•˜ë©´ mvcë‹¨ì—ì„œë§Œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê²Œ ë•Œë¬¸ì— ê·¸ë³´ë‹¤ ìƒìœ„ì¸ Servletì„ ê±°ì¹˜ì§€ ì•Šê²Œë¨
<strong>ë”°. ë¼. ì„œ í•´ë‹¹ í´ë¼ì´ì–¸íŠ¸ë¥¼ íê¸°í•˜ê¸°ë¡œ ê²°ì •!!</strong></p>
</blockquote>
<hr />
<h3 id="q2--ì •í™•íˆ-ì–´ë–¤ê²ƒê¹Œì§€-í…ŒìŠ¤íŒ…ì„-í• ê±´ì§€">Q2)  ì •í™•íˆ ì–´ë–¤ê²ƒê¹Œì§€ í…ŒìŠ¤íŒ…ì„ í• ê±´ì§€?</h3>
<p>ì´ì „ ì„¤ê³„ì—ì„œ ê²°êµ­ í†µí•© í…ŒìŠ¤íŠ¸ì—ì„œ ì¤‘ìš”í•œì ì€ <strong>1)ìŠ¤í”„ë§ ë¹ˆê³¼ì˜ ê²°í•© 2) ìš”ì²­ì— ë§ëŠ” ì•Œë§ì€ ì¿¼ë¦¬ ìš”ì²­</strong> ì´ì—ˆë‹¤.</p>
<p>í•˜ì§€ë§Œ ì–´ëŠì •ë„ ë””í…Œì¼ê¹Œì§€ í…ŒìŠ¤íŒ…ì„ í•´ì•¼í• ì§€ ëª°ë¼ì„œ ì´ ë¶€ë¶„ì„ í™•ì‹¤íˆ ì¡ê³  ê°”ë‹¤.</p>
<p>*<em>âœ… ìœ ë‹›í…ŒìŠ¤íŠ¸ì—ì„œ ì´ë¯¸ ë””í…Œì¼í•œ ë¡œì§ì— í…ŒìŠ¤íŠ¸ë¥¼ ì™„ë£Œí–ˆìŒ
âœ… í†µí•©í…ŒìŠ¤íŠ¸ì—ì„œ ë˜ í•´ë‹¹ë¡œì§ì„ ì¬ì ê²€ í•œë‹¤ë©´ ê°™ì€ ë™ì‘ì„ ë°˜ë³µí•˜ê²Œë˜ë©° ì—­í•  ë¶„ë¦¬ê°€ í•„ìš”
*</em></p>
<p>ê²°ë¡ !</p>
<blockquote>
<p>ìš”ì²­ë¶€í„° ì‘ë‹µê¹Œì§€ ì •ìƒì ìœ¼ë¡œ ë˜ëŠ”ì§€ë¥¼ í™•ì¸í•˜ë©° ì´ë•Œ í™•ì¸í•˜ëŠ” ë°©ë²•ì€,** ì˜¬ë°”ë¥¸ ìš”ì²­ê°’ í˜•íƒœ<strong>ë¡œ ë¶€í„° **ì˜¬ë°”ë¥¸ ì‘ë‹µê°’ í˜•íƒœ</strong>ê°€ ì˜¤ëŠëƒë§Œì„ í™•ì¸í•œë‹¤!!</p>
</blockquote>
<hr />
<h3 id="q3-ì¸ì¦-ì¸ê°€ë¥¼-ì–´ë–»ê²Œ-ì„¸íŒ…í•˜ì§€">Q3) ì¸ì¦ ì¸ê°€ë¥¼ ì–´ë–»ê²Œ ì„¸íŒ…í•˜ì§€?</h3>
<p>ê²°êµ­ ì‹¤ì œí™˜ê²½ê³¼ ê±°ì˜ ìœ ì‚¬í•œ í™˜ê²½ì„ ë§Œë“¤ê¸° ë•Œë¬¸ì— ì¸ì¦ ì¸ê°€ê¹Œì§€ ì²˜ë¦¬ë¥¼ í•´ì•¼í–ˆìŠµë‹ˆë‹¤.</p>
<p>2ê°€ì§€ ë°©ì‹ì„ êµ¬ìƒí•´ë´¤ëŠ”ë°ìš”...</p>
<blockquote>
</blockquote>
<ol>
<li>Redisì— ì‹¤ì œ ì„¸ì…˜ì„ ì‚½ì… í›„ @BeforeAllë¡œ ì„¸íŒ…í•˜ê³  í†µí•©í…ŒìŠ¤íŠ¸ ì‹œ ì¿ í‚¤ì— ì €ì¥</li>
<li>íšŒì› Repositoryì— ìœ ì € ì‚½ì… í›„ ì‹¤ì œ ë¡œê·¸ì¸ API í˜¸ì¶œ í›„ ì„¸ì…˜íšë“ ë° ì¿ í‚¤ì— ì €ì¥ </li>
</ol>
<p><code>1ë²ˆ ë°©ì‹</code>
<strong>ì†ë„ê°€ ë¹ ë¦„</strong> -&gt; ì¶”ê°€ì ì¸ apií˜¸ì¶œì´ ì—†ê¸° ë•Œë¬¸
<strong>ë‚œì´ë„ê°€ ë†’ìŒ</strong> -&gt; ì‹¤ì œ ì„¸ì…˜ ì¶”ê°€ íšë“ê°™ì€ ë¡œì§ì„ ì¶”ì í•´ì„œ ì •í™•í•œ Key-valueì— ê°’ì„ Redisì— ë“±ë¡í•´ì•¼í•¨
<code>2ë²ˆ ë°©ì‹</code>
<strong>ì†ë„ê°€ ëŠë¦¼</strong> -&gt; ì¶”ê°€ì ì¸ apií˜¸ì¶œì´ ìˆê¸° ë•Œë¬¸ì—
<strong>ë‚œì´ë„ê°€ ë‚®ìŒ</strong> -&gt; webtestclientë¡œ ì‘ë‹µì„ ë°›ì•„ì˜¤ë©´ ì‰½ê²Œ í•´ê²°ë¨</p>
<p><strong>ê²°ë¡ </strong> </p>
<blockquote>
<p><em>&quot;ì†ë„ëŠ” ëŠë ¤ì§ˆ ìˆ˜ ìˆì–´ë„ ë” ì•ˆì „í•˜ê³  ë¹ ë¥´ê²Œ ê°œë°œì´ ì™„ë£Œê°€ ê°€ëŠ¥í•œ ë°©ì‹ì´ê¸° ë•Œë¬¸ì— <strong>2ë²ˆ ë°©ì‹</strong>ì„ ì±„íƒí•˜ê¸°ë¡œí•¨!!&quot;</em></p>
</blockquote>
<hr />
<h1 id="í•µì‹¬-ì½”ë“œ">í•µì‹¬ ì½”ë“œ</h1>
<h3 id="initintegration-í´ë˜ìŠ¤">InitIntegration í´ë˜ìŠ¤</h3>
<p>ëª¨ë“  Integrationì—ì„œ ê³µìœ í•˜ê³  ì¬ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•˜ê¸° ìœ„í•´ <strong>ê³µí†µ ë¶€ëª¨í´ë˜ìŠ¤ë¥¼ êµ¬í˜„í•¨</strong></p>
<p><code>í•µì‹¬ ë¡œì§</code></p>
<blockquote>
</blockquote>
<ol>
<li>í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆë¥¼ í†µí•´ í•„ìš”í•œ ì¸í”„ë¼ë¥¼ ë„ì»¤ ì»¨í…Œì´ë„ˆ ìœ„ì—ì„œ ì‹¤í–‰
 -&gt; @BeforeAllë¡œ ëª¨ë“  í†µí•© í…ŒìŠ¤íŠ¸ì—ì„œ 1ë²ˆë§Œ ì‹¤í–‰í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•¨</li>
<li>Login APIë¥¼ ë™ì‘í•´ protectedë³€ìˆ˜ë¡œ ìì‹ ì—ê²Œ ë„˜ê²¨ì¤Œ</li>
<li>webTestClient ì¸ìŠ¤í„´ìŠ¤ë¥¼ protectedë³€ìˆ˜ë¡œ ìì‹ ì—ê²Œ ë„˜ê²¨ì¤Œ</li>
</ol>
<p><code>ì½”ë“œ</code></p>
<pre><code class="language-java">@Testcontainers
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@ActiveProfiles(&quot;integration&quot;)
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
@TestPropertySource(locations = &quot;classpath:application-integration-test.yml&quot;)
public class InitIntegrationTest {

  // WebTestClientë¥¼ ì£¼ì…ë°›ì•„ HTTP ìš”ì²­ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
  @Autowired
  protected WebTestClient client;

  // Redisì™€ MySQLì˜ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
  private static final String MYSQL_IMAGE = &quot;mysql:latest&quot;;
  private static final String REDIS_IMAGE = &quot;redis:latest&quot;;
  private static final int REDIS_PORT = 6379;

  @Container
  @ServiceConnection
  static public GenericContainer&lt;?&gt; redis = new GenericContainer&lt;&gt;(
      DockerImageName.parse(REDIS_IMAGE))
      .withExposedPorts(REDIS_PORT)
      .waitingFor(Wait.forListeningPort())
      .waitingFor(Wait.defaultWaitStrategy());

  @Container
  static public MySQLContainer&lt;?&gt; mysql = new MySQLContainer&lt;&gt;(DockerImageName.parse(MYSQL_IMAGE))
      .waitingFor(Wait.forListeningPort());

  @BeforeAll
  static void setUp() {
    System.setProperty(&quot;spring.data.redis.host&quot;, redis.getHost());
    System.setProperty(&quot;spring.data.redis.port&quot;, redis.getFirstMappedPort().toString());
    System.setProperty(&quot;spring.datasource.url&quot;, mysql.getJdbcUrl());
    System.setProperty(&quot;spring.datasource.username&quot;, mysql.getUsername());
    System.setProperty(&quot;spring.datasource.password&quot;, mysql.getPassword());
  }

  @AfterAll
  static void tearDown() {
    System.clearProperty(&quot;spring.data.redis.host&quot;);
    System.clearProperty(&quot;spring.data.redis.port&quot;);
    System.clearProperty(&quot;spring.datasource.url&quot;);
    System.clearProperty(&quot;spring.datasource.username&quot;);
    System.clearProperty(&quot;spring.datasource.password&quot;);
  }

  protected static String sessionToken;

  /**
   * ì‹¤ì œ ë¡œê·¸ì¸ ìš”ì²­ ì´í›„ sessionTokenì— ìœ íš¨í•œ ì„¸ì…˜ ì €ì¥
   *
   * @param client
   * @param memberRepository
   * @param carRepository
   * @param passwordEncoder
   */
  @BeforeAll
  static void initTestUser(@Autowired WebTestClient client,
      @Autowired MemberRepository memberRepository,
      @Autowired CarRepository carRepository,
      @Autowired BCryptPasswordEncoder passwordEncoder) {

    CarEntity integrationCar = CarEntity.builder()
        .carNumber(&quot;integration-car&quot;)
        .carType(CarType.COMPACT)
        .isElectric(false).build();

    MemberEntity member = MemberEntity.builder()
        .authId(&quot;integration&quot;)
        .birthday(&quot;01-01&quot;)
        .birthdayYear(1990)
        .email(&quot;integration@example.com&quot;)
        .loginPlatform(LoginPlatform.NORMAL)
        .password(passwordEncoder.encode(&quot;integration&quot;))
        .phoneNumber(&quot;01012341234&quot;)
        .role(MemberRole.ROLE_USER)
        .userName(&quot;name1&quot;)
        .carEntity(integrationCar)
        .build();

    carRepository.save(integrationCar);
    memberRepository.save(member);

    // ë¡œê·¸ì¸ ìš”ì²­ í›„ ì„¸ì…˜ í† í° ì €ì¥
    Map&lt;String, String&gt; loginRequest = Map.of(
        &quot;username&quot;, &quot;integration&quot;,
        &quot;password&quot;, &quot;integration&quot;
    );

    client.post()
        .uri(&quot;/api/v1/auth/login&quot;)
        .contentType(MediaType.APPLICATION_FORM_URLENCODED)
        .body(BodyInserters.fromFormData(&quot;username&quot;, loginRequest.get(&quot;username&quot;))
            .with(&quot;password&quot;, loginRequest.get(&quot;password&quot;)))
        .exchange()
        .expectStatus().isOk()
        .expectBody()
        .consumeWith(response -&gt; {
          // ì „ì²´ ì¿ í‚¤ ëª©ë¡ ì¶œë ¥
          Map&lt;String, List&lt;ResponseCookie&gt;&gt; cookies = response.getResponseCookies();
//          System.out.println(&quot;ğŸ” ì „ì²´ ì¿ í‚¤ ëª©ë¡: &quot; + cookies);

          // &quot;SESSION&quot; ì¿ í‚¤ì—ì„œ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
          sessionToken = cookies.get(&quot;SESSION&quot;).stream()
              .findFirst()
              .map(ResponseCookie::getValue)  // ì¿ í‚¤ ê°’ë§Œ ì¶”ì¶œ
              .orElse(null);

          // sessionTokenì´ nullì´ ì•„ë‹Œì§€ ê²€ì¦
          assertThat(sessionToken)
              .as(&quot;ë¡œê·¸ì¸ í›„ ì„¸ì…˜ ì¿ í‚¤ê°€ ì •ìƒì ìœ¼ë¡œ ë°˜í™˜ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.&quot;)
              .isNotNull();

        });
  }</code></pre>
<hr />
<h3 id="prë§í¬"><a href="https://github.com/Team-Devmon-IN-KU/HonorsParking-BE/pull/40">PRë§í¬</a></h3>
<hr />
<h3 id="ref">REF</h3>
<ol>
<li><a href="https://docs.spring.io/spring-framework/reference/testing/webtestclient.html">Spring Web test client ê³µì‹ ë¬¸ì„œ</a></li>
</ol>